module.exports=[58139,a=>{"use strict";var b=a.i(41063),c=a.i(59263),d=a.i(29024);a.i(16162);var e=a.i(25161),f=a.i(69168),g=a.i(76181),h=a.i(35976),i=a.i(72273);let j=c.z.object({email:c.z.string().email({message:"Please enter a valid email address."}),password:c.z.string().min(1,{message:"Password is required."})}),k=c.z.object({email:c.z.string().email({message:"Please enter a valid email address."}),password:c.z.string().min(8,{message:"Password must be at least 8 characters long."})});async function l(a,b){let c=await (0,d.createClient)(),f=j.safeParse(Object.fromEntries(b.entries()));if(!f.success)return{errors:f.error.flatten().fieldErrors,message:"Invalid fields. Please check your email and password."};let{email:h,password:i}=f.data,{data:k,error:l}=await c.auth.signInWithPassword({email:h,password:i});if(l||!k.user)return{message:l?.message||"Authentication failed. Please check your credentials."};if(await (0,g.checkProfileCompletion)(k.user.id)){let a=b.get("post_login_item"),d=b.get("post_login_type");if(a&&d){let{data:b}=await c.from("profiles").select("username").eq("id",k.user.id).single();b?.username&&(0,e.redirect)(`/profile/${b.username}/timeline/create?item=${a}&type=${d}`)}(0,e.redirect)("/profile")}else(0,e.redirect)("/onboarding")}async function m(a,b){let c=await (0,d.createClient)(),f=k.safeParse(Object.fromEntries(b.entries()));if(!f.success)return{errors:f.error.flatten().fieldErrors,message:"Invalid fields. Please check the form for errors."};let{email:g,password:h}=f.data,{data:i,error:j}=await c.rpc("email_exists",{email_to_check:g});if(j)return console.error("Email check RPC error:",j),{message:"Something went wrong. Please try again."};if(i)return{message:"An account with this email already exists. Please log in."};let l=new URL("https://www.deeperweave.com/").origin,{error:m}=await c.auth.signUp({email:g,password:h,options:{emailRedirectTo:`${l}/auth/confirm`}});if(m)return{message:m.message};(0,e.redirect)(`/auth/sign-up-success?email=${encodeURIComponent(g)}`)}let n=c.z.object({password:c.z.string().min(8,"Password must be at least 8 characters long."),confirmPassword:c.z.string()}).refine(a=>a.password===a.confirmPassword,{message:"Passwords do not match.",path:["confirmPassword"]});async function o(a,b){let c=await (0,d.createClient)(),e=n.safeParse(Object.fromEntries(b.entries()));if(!e.success)return{errors:e.error.flatten().fieldErrors,message:"Please check the form for errors."};let{password:f}=e.data,{error:g}=await c.auth.updateUser({password:f});return g?(console.error("Update password error:",g),{message:"Failed to update password. The link may have expired."}):{success:!0,message:"Your password has been updated successfully!"}}let p=c.z.object({email:c.z.string().email({message:"Please enter a valid email address."})});async function q(a,b){let c=await (0,d.createClient)(),e=p.safeParse(Object.fromEntries(b.entries()));if(!e.success)return{errors:e.error.flatten().fieldErrors,message:"Invalid email."};let{email:f}=e.data,g=new URL("https://www.deeperweave.com/").origin,h=`${g}/auth/confirm?next=/auth/reset-password`,{error:i}=await c.auth.resetPasswordForEmail(f,{redirectTo:h});return i&&console.error("Password reset error:",i),{success:!0,message:"If an account with this email exists, a reset link has been sent."}}async function r(){let a=await (0,d.createClient)();await a.auth.signOut(),(0,f.revalidatePath)("/","layout"),(0,e.redirect)("/")}async function s(){let a=await (0,d.createClient)(),b=(await (0,h.headers)()).get("origin"),{data:c,error:f}=await a.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${b}/auth/confirm`,queryParams:{access_type:"offline",prompt:"consent"}}});if(f)return console.error("Google Sign In Error:",f),{message:"Could not authenticate with Google"};c.url&&(0,e.redirect)(c.url)}(0,i.ensureServerEntryExports)([l,m,o,q,r,s]),(0,b.registerServerReference)(l,"60ff8e559252d5a6051ced766dadb1ccbb8ddfd0f9",null),(0,b.registerServerReference)(m,"60d50f0d96dcd7a64a44e980c7b35a1620f5677e58",null),(0,b.registerServerReference)(o,"60ff4eeaba83819f4c10c4605d95c6ddbd3d58ff5b",null),(0,b.registerServerReference)(q,"608db67d335ccb3885330fdc306fdbd1abbb9521d6",null),(0,b.registerServerReference)(r,"00a5e44efe8453720c80c4486c1d17d72add854a24",null),(0,b.registerServerReference)(s,"00c5bd2edb3b8d4fade54dc90e90624a8e1ae206b4",null),a.s(["login",()=>l,"logout",()=>r,"requestPasswordReset",()=>q,"signInWithGoogle",()=>s,"signup",()=>m,"updatePassword",()=>o])},38324,a=>{"use strict";var b=a.i(41063),c=a.i(44995),d=a.i(72273);let e=async()=>(0,c.createClient)("https://jyjynjpznlvezjhnuwhi.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1,autoRefreshToken:!1}});(0,d.ensureServerEntryExports)([e]),(0,b.registerServerReference)(e,"007f4304d26a5fb9f73eb78d5882ca3b3d3f30d5f2",null),a.s(["createAdminClient",0,e])},74377,a=>{"use strict";var b=a.i(41063),c=a.i(29024),d=a.i(69168);async function e({recipientId:a,actorId:b,actorUsername:d,type:e,targetPostId:f}){if(a===b)return;let g=await (0,c.createClient)(),h={recipient_id:a,actor_id:b,actor_username:d,type:e,is_read:!1};f&&(h.target_post_id=f);let{error:i}=await g.from("notifications").insert(h);i&&console.error("Failed to create notification:",i)}async function f(a){let b=await (0,c.createClient)();await b.from("notifications").update({is_read:!0}).eq("id",a),(0,d.revalidatePath)("/profile/notifications")}async function g(a){let b=await (0,c.createClient)();await b.from("notifications").delete().eq("id",a),(0,d.revalidatePath)("/profile/notifications")}async function h(a){let b=await (0,c.createClient)();await b.from("notifications").update({is_read:!0}).eq("recipient_id",a),(0,d.revalidatePath)("/profile/notifications")}async function i({actorId:a,type:b,recipientId:d,targetPostId:e}){let f=(await (0,c.createClient)()).from("notifications").delete({count:"exact"}).eq("actor_id",a).eq("type",b);d&&(f=f.eq("recipient_id",d)),f=e?f.eq("target_post_id",e):f.is("target_post_id",null);let{error:g}=await f;g&&console.error("âŒ Failed to delete notification:",g.message)}(0,a.i(72273).ensureServerEntryExports)([e,f,g,h,i]),(0,b.registerServerReference)(e,"4055d54f0d2ce76fe4785b7a81a03bfc7992dd262e",null),(0,b.registerServerReference)(f,"40b2724402b497cfd26d5086c2042bf019bb6870be",null),(0,b.registerServerReference)(g,"40bc84fad6ba83d0ba85bf176415a72eeef431e50e",null),(0,b.registerServerReference)(h,"40c0cbdc7402307eb18de4ec6234fefc650ff8bbf8",null),(0,b.registerServerReference)(i,"409b80e89bed5cbab2bcde39cf4ed6945329720442",null),a.s(["createNotification",()=>e,"deleteNotification",()=>i,"dismissNotification",()=>g,"markAllNotificationsAsRead",()=>h,"markNotificationAsRead",()=>f])},68084,a=>{"use strict";var b=a.i(41063),c=a.i(29024),d=a.i(69168),e=a.i(74377),f=a.i(76181);async function g(a,b){let g=await (0,c.createClient)(),h=await (0,f.getUserProfile)();if(!h?.user||!h.profile)return{error:"You must be logged in to follow user."};let{user:i,profile:j}=h;if(i.id===a)return{error:"You cannot follow yourself."};let{error:k}=await g.from("followers").upsert({follower_id:i.id,following_id:a,status:b?"pending":"accepted"});return k?(console.error("Follow error:",k),{error:"Could not follow user."}):(await (0,e.createNotification)({recipientId:a,actorId:i.id,actorUsername:j.username,type:b?"follow_request":"new_follower",targetPostId:null}),(0,d.revalidatePath)(`/profile/${a}`),{success:!0})}async function h(a){let b=await (0,c.createClient)(),{data:{user:f}}=await b.auth.getUser();if(!f)return{error:"You must be logged in."};let{error:g}=await b.from("followers").delete().eq("follower_id",f.id).eq("following_id",a);return g?(console.error("Unfollow error:",g),{error:"Could not unfollow user."}):(await (0,e.deleteNotification)({actorId:f.id,recipientId:a,type:"new_follower",targetPostId:null}),await (0,e.deleteNotification)({actorId:f.id,recipientId:a,type:"follow_request",targetPostId:null}),(0,d.revalidatePath)(`/profile/${a}`),{success:!0})}async function i(a){let b=await (0,c.createClient)(),{data:{user:e}}=await b.auth.getUser();if(!e)return{error:"You must be logged in."};let{error:f}=await b.from("followers").update({status:"accepted"}).eq("follower_id",a).eq("following_id",e.id);return f?{error:"Could not approve request."}:(await b.from("notifications").update({type:"new_follower",created_at:new Date().toISOString(),is_read:!1}).match({recipient_id:e.id,actor_id:a,type:"follow_request"}),(0,d.revalidatePath)("/profile/notifications"),{success:!0})}async function j(a){let b=await (0,c.createClient)(),{data:{user:e}}=await b.auth.getUser();if(!e)return{error:"You must be logged in."};let{error:f}=await b.from("followers").delete().eq("follower_id",a).eq("following_id",e.id);return f?{error:"Could not deny request."}:(await b.from("notifications").delete().match({recipient_id:e.id,actor_id:a,type:"follow_request"}),(0,d.revalidatePath)("/profile/notifications"),{success:!0})}(0,a.i(72273).ensureServerEntryExports)([g,h,i,j]),(0,b.registerServerReference)(g,"60264de08d08b576a3585ab046b1acac7b5bdabd3b",null),(0,b.registerServerReference)(h,"40d99d04cbee478751a6ae749c1853a5bc0183a343",null),(0,b.registerServerReference)(i,"40b5bd0aea50cc5adfd1e8852ddb8edf2a480c29d7",null),(0,b.registerServerReference)(j,"4070b54d0ab513c0f16507f7657e23bd9a1baf315d",null),a.s(["approveFollowRequest",()=>i,"denyFollowRequest",()=>j,"followUser",()=>g,"unfollowUser",()=>h])},18644,a=>{"use strict";var b=a.i(41063),c=a.i(59263),d=a.i(29024);a.i(16162);var e=a.i(25161),f=a.i(69168),g=a.i(76216),h=a.i(76181),i=a.i(72273);let j=c.z.object({username:c.z.string().min(3,"Username must be at least 3 characters.").regex(/^[a-z0-9_]+$/,"Username can only contain lowercase letters, numbers, and underscores."),display_name:c.z.string().min(1,"Display name is required."),date_of_birth:c.z.string().refine(a=>{let b=new Date,c=new Date(a),d=b.getFullYear()-c.getFullYear(),e=b.getMonth()-c.getMonth();return(e<0||0===e&&b.getDate()<c.getDate())&&d--,d>=18},{message:"You must be at least 18 years old to join."}),country:c.z.string().min(1,"Please select your country."),gender:c.z.enum(["male","female","non-binary","prefer_not_to_say"],{message:"Please select a gender option."})});async function k(a,b){let c=await (0,d.createClient)(),{data:{user:g}}=await c.auth.getUser();if(!g)return{message:"Authentication error. Please log in again."};let h=j.safeParse(Object.fromEntries(b.entries()));if(!h.success)return{errors:h.error.flatten().fieldErrors,message:"There were errors with your submission. Please review the fields."};let{username:i,display_name:k,date_of_birth:l,country:m,gender:n}=h.data,{data:o}=await c.from("profiles").select("username").eq("username",i).neq("id",g.id).maybeSingle();if(o)return{errors:{username:["This username is already taken."]},message:"Username is unavailable."};let{error:p}=await c.from("profiles").upsert({id:g.id,username:i,display_name:k,date_of_birth:l,country:m,gender:n});if(p)return console.error("Profile update error:",p),{message:"Database error: Could not save profile."};(0,f.revalidatePath)("/profile","layout"),(0,e.redirect)("/profile")}let l=c.z.object({username:c.z.string().min(3,"Username must be at least 3 characters.").regex(/^[a-z0-9_]+$/,"Username can only contain lowercase letters, numbers, and underscores."),display_name:c.z.string().min(1,"Display name is required."),bio:c.z.string().max(160,"Bio cannot be longer than 160 characters.").optional(),sections_json:c.z.string().optional()});async function m(a,b){let c=await (0,d.createClient)(),{data:{user:e}}=await c.auth.getUser();if(!e)return{message:"Authentication error. Please log in again."};let h=l.safeParse(Object.fromEntries(b.entries()));if(!h.success)return{errors:h.error.flatten().fieldErrors,message:"There were errors with your submission."};let{username:i,display_name:j,bio:k,sections_json:m}=h.data,{data:n}=await c.from("profiles").select("username").eq("username",i).neq("id",e.id).maybeSingle();if(n)return{errors:{username:["This username is already taken."]},message:"Username is unavailable."};let o={username:i,display_name:j,bio:k},p=b.get("profile_pic");if(p&&p.size>0)try{let{data:a}=await c.storage.from("profile_pics").list(e.id);if(a&&a.length>0){let b=a.map(a=>`${e.id}/${a.name}`);await c.storage.from("profile_pics").remove(b)}let b=p.name.split(".").pop(),d=Date.now(),f=`${e.id}/profile-${d}.${b}`,{error:g}=await c.storage.from("profile_pics").upload(f,p,{upsert:!0,cacheControl:"3600"});if(g)throw g;let{data:{publicUrl:h}}=c.storage.from("profile_pics").getPublicUrl(f);o.profile_pic_url=h}catch(a){return console.error("Profile Pic Error:",a),{message:"Database error: Could not upload profile picture."}}let{error:q}=await c.from("profiles").update(o).eq("id",e.id);if(q)return console.error("Profile update error:",q),{message:"Database error: Could not update profile details."};if(m)try{let a=JSON.parse(m),b=new Set,d=new Set,f=new Set;a.forEach(a=>{a.items&&Array.isArray(a.items)&&a.items.forEach(a=>{if(!a)return;let c=Number(a.id);"movie"===a.type?b.add(c):"tv"===a.type?d.add(c):"person"===a.type&&f.add(c)})});let h=Array.from(b);if(h.length>0){let{data:a}=await c.from("movies").select("tmdb_id").in("tmdb_id",h),b=new Set(a?.map(a=>a.tmdb_id)||[]),d=h.filter(a=>!b.has(a));d.length>0&&await Promise.all(d.map(a=>(0,g.cacheMovie)(a)))}let i=Array.from(d);if(i.length>0){let{data:a}=await c.from("series").select("tmdb_id").in("tmdb_id",i),b=new Set(a?.map(a=>a.tmdb_id)||[]),d=i.filter(a=>!b.has(a));d.length>0&&await Promise.all(d.map(a=>(0,g.cacheSeries)(a)))}let j=Array.from(f);if(j.length>0){let{data:a}=await c.from("people").select("tmdb_id").in("tmdb_id",j),b=new Set(a?.map(a=>Number(a.tmdb_id))||[]),d=j.filter(a=>!b.has(a));d.length>0&&await Promise.all(d.map(a=>(0,g.cachePerson)(a)))}await c.from("profile_sections").delete().eq("user_id",e.id);for(let b=0;b<a.length;b++){let d=a[b],{data:f,error:g}=await c.from("profile_sections").insert({user_id:e.id,title:d.title,type:d.type,rank:b+1}).select("id").single();if(g||!f)continue;let h=(d.items||[]).map((a,b)=>a?{section_id:f.id,item_type:a.type,movie_id:"movie"===a.type?Number(a.id):null,series_id:"tv"===a.type?Number(a.id):null,person_id:"person"===a.type?Number(a.id):null,rank:b+1}:null).filter(Boolean);h.length>0&&await c.from("section_items").insert(h)}}catch(a){return console.error("Error processing sections:",a),{message:"Saved profile, but failed to update showcase sections."}}return(0,f.revalidatePath)("/profile","layout"),(0,f.revalidatePath)(`/profile/${i}`),{message:"Success"}}async function n(a){let b=await (0,d.createClient)(),{data:{user:c}}=await b.auth.getUser();if(!c)return{available:!1,message:"Not authenticated"};if(!a||a.length<3)return{available:!1,message:"Username too short"};let{data:e,error:f}=await b.from("profiles").select("id").eq("username",a).neq("id",c.id).maybeSingle();return f?{available:!1,message:"Database error"}:e?{available:!1,message:"Username is already taken."}:{available:!0,message:"Username is available!"}}let o=c.z.object({visibility:c.z.enum(["public","private"]),content_preference:c.z.enum(["sfw","all"])});async function p(a,b){let c=await (0,d.createClient)(),{data:{user:g}}=await c.auth.getUser();if(!g)return{message:"Authentication error."};let h=o.safeParse(Object.fromEntries(b.entries()));if(!h.success)return{errors:h.error.flatten().fieldErrors,message:"Invalid data provided."};let{visibility:i,content_preference:j}=h.data,{error:k}=await c.from("profiles").update({visibility:i,content_preference:j}).eq("id",g.id);return k?(console.error("Settings update error:",k),{message:"Database Error: Could not update settings."}):((0,f.revalidatePath)("/profile/settings"),(0,f.revalidatePath)("/profile"),(0,e.redirect)("/profile"),{message:"Your settings have been saved successfully!"})}async function q(a){if(a.length<2)return[];let b=await (0,d.createClient)(),{data:{user:c}}=await b.auth.getUser(),{data:e,error:f}=await b.from("profiles").select(`
            id, 
            username, 
            display_name, 
            profile_pic_url, 
            bio, 
            role,
            visibility
        `).textSearch("fts",a,{type:"websearch",config:"english"}).limit(10);if(f||!e)return console.error("Search error:",f),[];let g=new Map;if(c&&e.length>0){let a=e.map(a=>a.id),{data:d}=await b.from("followers").select("following_id, status").eq("follower_id",c.id).in("following_id",a);d&&d.forEach(a=>{g.set(a.following_id,a.status)})}return e.map(a=>({...a,visibility:a.visibility,follow_status:g.get(a.id)||"not_following"}))}async function r(a){(0,f.unstable_noStore)();let b=await (0,d.createClient)(),{data:c}=await b.from("profiles").select("*, follower_count:followers!following_id(count), following_count:followers!follower_id(count)").eq("username",a).single();if(!c)return{profile:null,followerCount:0,followingCount:0};let e=c.follower_count[0]?.count||0,g=c.following_count[0]?.count||0;return{profile:c,followerCount:e,followingCount:g}}let s=c.z.object({confirmation:c.z.string().refine(a=>"DELETE"===a,{message:'You must type "DELETE" to confirm.'})});async function t(a,b){let c=await (0,d.createClient)(),{data:{user:g}}=await c.auth.getUser();if(!g)return{message:"Authentication error."};let h=s.safeParse(Object.fromEntries(b.entries()));if(!h.success)return{errors:h.error.flatten().fieldErrors,message:"Confirmation is incorrect."};try{let{data:a}=await c.storage.from("profile_pics").list(g.id);if(a&&a.length>0){let b=a.map(a=>`${g.id}/${a.name}`),{error:d}=await c.storage.from("profile_pics").remove(b);d&&console.error("Failed to delete profile pics:",d)}let{data:b}=await c.storage.from("timeline_photos").list(g.id);if(b&&b.length>0){let a=b.map(a=>`${g.id}/${a.name}`);await c.storage.from("timeline_photos").remove(a)}}catch(a){console.error("Error cleaning up storage files:",a)}let{error:i}=await c.rpc("delete_my_account");if(i)return console.error("Account deletion RPC error:",i),{message:"A server error occurred. Could not delete account."};await c.auth.signOut(),(0,f.revalidatePath)("/","layout"),(0,e.redirect)("/delete-success")}async function u(a){let b=await (0,h.getPodiumData)(a);return b&&b.sections?b.sections:[]}(0,i.ensureServerEntryExports)([k,m,n,p,q,r,t,u]),(0,b.registerServerReference)(k,"6098dd31f5c91fea51e8ba3ed960e9643949d4ed86",null),(0,b.registerServerReference)(m,"60826a603a5eb3b50712d45c43376b4589f187388b",null),(0,b.registerServerReference)(n,"4092c60b305f7924ea37b3c4bc9f2b2781f78b9557",null),(0,b.registerServerReference)(p,"6033811cc695c99ac267e43ae44d701bcfe54b5c60",null),(0,b.registerServerReference)(q,"40db3109247e2eda43546539812bc50eb62478030b",null),(0,b.registerServerReference)(r,"40e7b2cc38b97e02723fa1a69b8372d45365f40226",null),(0,b.registerServerReference)(t,"6065cab676e3ca618e984c2e418a52303a977aec2d",null),(0,b.registerServerReference)(u,"40eef552ad3c8496caa0b2bae6f553ad85b09fe36f",null),a.s(["checkUsernameAvailability",()=>n,"completeProfile",()=>k,"deleteMyAccount",()=>t,"getProfileCardData",()=>r,"searchProfiles",()=>q,"updateProfile",()=>m,"updateProfileSettings",()=>p])},90093,a=>{"use strict";var b=a.i(41063),c=a.i(38324),d=a.i(69168),e=a.i(29024);async function f(b){(0,d.unstable_noStore)();let{createClient:c}=await a.A(56941),e=await c(),{data:f,error:g}=await e.from("timeline_entries").select(`
            *,
            movies (*),
            series (*),
            posts (slug),
            timeline_collaborators (*, profiles (id, username, profile_pic_url))
        `).eq("user_id",b).order("watched_on",{ascending:!0}).order("created_at",{ascending:!0});if(g)return console.error("Error fetching timeline entries:",g),[];let h={};return f.map(a=>{let b=Array.isArray(a.movies)?a.movies[0]:a.movies,c=Array.isArray(a.series)?a.series[0]:a.series,d=b?`movie_${b.tmdb_id}`:c?`tv_${c.tmdb_id}`:null,e=0;d&&(h[d]=(h[d]||0)+1,e=h[d]);let f=e>0?e-1:0;return{...a,movies:b,series:c,posts:Array.isArray(a.posts)?a.posts[0]:a.posts,timeline_collaborators:(a.timeline_collaborators||[]).map(a=>({...a,profiles:Array.isArray(a.profiles)?a.profiles[0]:a.profiles})),is_rewatch:f>0,rewatch_count:f}}).reverse()}async function g(a){(0,d.unstable_noStore)();let b=await (0,c.createAdminClient)(),{data:e,error:f}=await b.from("timeline_entries").select(`
            *,
            movies (*),
            series (*),
            posts (slug),
            profiles:user_id (username, display_name, profile_pic_url),
            timeline_collaborators (*, profiles (id, username, profile_pic_url))
        `).eq("id",a).single();if(f||!e)return console.error(`Supabase error fetching timeline entry ${a} (as admin):`,f),null;let g={...e,movies:Array.isArray(e.movies)?e.movies[0]:e.movies,series:Array.isArray(e.series)?e.series[0]:e.series,posts:Array.isArray(e.posts)?e.posts[0]:e.posts,profiles:Array.isArray(e.profiles)?e.profiles[0]:e.profiles,timeline_collaborators:(e.timeline_collaborators||[]).map(a=>({...a,profiles:Array.isArray(a.profiles)?a.profiles[0]:a.profiles}))};return g.movies||g.series?g.profiles?g:(console.error(`Error: Timeline entry ${a} has no associated profile.`),null):(console.error(`Error: Timeline entry ${a} has no associated movie or series data.`),null)}async function h(a,b,c){(0,d.unstable_noStore)();let f=await (0,e.createClient)(),g="movie"===b?"movie_id":"series_id",{data:h}=await f.from("timeline_entries").select("*").eq("user_id",a).eq(g,c).order("watched_on",{ascending:!1}),{data:i}=await f.from("followers").select("following_id").eq("follower_id",a).eq("status","accepted"),j=i?.map(a=>a.following_id)||[],k=[];if(j.length>0){let{data:a}=await f.from("timeline_entries").select(`
                *,
                profiles:user_id (username, display_name, profile_pic_url)
            `).in("user_id",j).eq(g,c).order("watched_on",{ascending:!1});a&&(k=a)}return{myEntries:h||[],friendEntries:k||[],watchCount:h?.length||0}}(0,a.i(72273).ensureServerEntryExports)([f,g,h]),(0,b.registerServerReference)(f,"405a83a00c08994b5b17f545dc1643993ea0e7347c",null),(0,b.registerServerReference)(g,"40153f24d01cf51e6e896446d274d46439a44fa7a1",null),(0,b.registerServerReference)(h,"70e9e03f0bdc6e37bedcf6c3e98007fde46de58de2",null),a.s(["getCinematicEngagement",()=>h,"getTimelineEntriesByUserId",()=>f,"getTimelineEntryById",()=>g])},71562,a=>{"use strict";var b=a.i(41063),c=a.i(59263),d=a.i(29024),e=a.i(69168);a.i(16162);var f=a.i(25161),g=a.i(76181),h=a.i(76216),i=a.i(90093),j=a.i(72273);let k=["image/jpeg","image/png","image/webp","image/heic"],l=c.z.object({cinematicApiId:c.z.coerce.number().optional(),media_type:c.z.enum(["movie","tv"]).optional(),watched_on:c.z.string().refine(a=>!isNaN(Date.parse(a)),{message:"Please enter a valid date."}),rating:c.z.coerce.number().min(0,"A rating is required.").max(5).step(.5),notes:c.z.string().max(1e3,"Notes cannot exceed 1000 characters.").optional(),viewing_medium:c.z.enum(["theatre","ott"]).optional(),ott_platform:c.z.string().optional(),photo:c.z.instanceof(File).optional().refine(a=>!a||0===a.size||a.size<=5242880,"Max image size is 5MB.").refine(a=>!a||0===a.size||k.includes(a.type),"Only .jpg, .png, .webp, and .heic formats are supported."),watched_with:c.z.array(c.z.string().uuid()).optional()}).superRefine((a,b)=>{a.cinematicApiId||b.addIssue({code:c.z.ZodIssueCode.custom,message:"You must select a movie or series.",path:["cinematicApiId"]}),a.cinematicApiId&&!a.media_type&&b.addIssue({code:c.z.ZodIssueCode.custom,message:"Media type is missing. Please re-select your item.",path:["cinematicApiId"]}),"ott"!==a.viewing_medium||a.ott_platform&&""!==a.ott_platform.trim()||b.addIssue({code:c.z.ZodIssueCode.custom,message:"Please select an OTT platform.",path:["ott_platform"]})});async function m(a,b){let c,i,j=await (0,d.createClient)(),k=await (0,g.getUserProfile)();if(!k?.user||!k.profile)return{message:"Authentication Error: You must be logged in to log an entry."};let m={};for(let[a,c]of b.entries())"watched_with"!==a&&(m[a]=c);m.watched_with=b.getAll("watched_with");let n=b.get("photo");n instanceof File&&n.size>0?m.photo=n:m.photo=void 0,"0"===m.rating&&(m.rating=0);let o=l.safeParse(m);if(!o.success)return{errors:o.error.flatten().fieldErrors,message:"Invalid data. Please check the form and try again."};let{cinematicApiId:p,media_type:q,watched_on:r,rating:s,notes:t,viewing_medium:u,ott_platform:v,photo:w,watched_with:x}=o.data;if(!p||!q)return{message:"Validation failed unexpectedly. Missing cinematic ID or media type."};try{"movie"===q?(await (0,h.cacheMovie)(p),c=p):"tv"===q&&(await (0,h.cacheSeries)(p),i=p)}catch(a){return console.error("Timeline cinematic upsert error:",a),{message:"Server Error: Could not save movie/series details."}}let y=j.from("timeline_entries").select("id").eq("user_id",k.user.id);"movie"===q?y.eq("movie_id",p):y.eq("series_id",p);let{data:z}=await y,A=!!z&&z.length>0,B=null;if(w){let a=w.name.split(".").pop(),b=`${k.user.id}/${p}-${Date.now()}.${a}`,{error:c}=await j.storage.from("timeline_photos").upload(b,w,{upsert:!0,cacheControl:"3600"});if(c)return console.error("Photo upload error:",c),{message:"Database Error: Could not upload photo."};let{data:{publicUrl:d}}=j.storage.from("timeline_photos").getPublicUrl(b);B=d}let C=null;"theatre"===u?C="Theatre":"ott"===u&&v&&(C=v);let D={user_id:k.user.id,movie_id:c,series_id:i,watched_on:r,rating:0===s?null:s,notes:t||null,is_rewatch:A,photo_url:B,viewing_context:C},{data:E,error:F}=await j.from("timeline_entries").insert(D).select("id").single();if(F)return console.error("Timeline insert error:",F),{message:"Database Error: Could not log your entry."};if(x&&x.length>0){let a=x.map(a=>({entry_id:E.id,user_id:a})),{error:b}=await j.from("timeline_collaborators").insert(a);b&&console.error("Collaborator insert error:",b)}return(0,e.revalidatePath)(`/profile/${k.profile.username}/timeline`),(0,f.redirect)(`/profile/${k.profile.username}/timeline`),{message:"Success"}}async function n(a,b){let c=await (0,d.createClient)(),h=await (0,g.getUserProfile)();if(!h?.user||!h.profile)return{message:"Authentication Error: You must be logged in."};let i=b.get("entryId");if(!i)return{message:"Error: Entry ID is missing. Cannot update."};let{data:j,error:k}=await c.from("timeline_entries").select("user_id, photo_url, movie_id, series_id").eq("id",i).single();if(k||!j)return{message:"Error: Could not find the entry to update."};if(j.user_id!==h.user.id)return{message:"Authorization Error: You can only edit your own entries."};let m={};for(let[a,c]of b.entries())"watched_with"!==a&&(m[a]=c);m.watched_with=b.getAll("watched_with");let n=b.get("photo");n instanceof File&&n.size>0?m.photo=n:m.photo=void 0,"0"===m.rating&&(m.rating=0);let o=l.safeParse(m);if(!o.success)return{errors:o.error.flatten().fieldErrors,message:"Invalid data. Please check the form and try again."};let{cinematicApiId:p,media_type:q,watched_on:r,rating:s,notes:t,viewing_medium:u,ott_platform:v,photo:w,watched_with:x}=o.data,y=j.movie_id||j.series_id,z=j.movie_id?"movie":"tv";if(p!==y||q!==z)return{message:"Error: Cinematic item cannot be changed when editing an entry."};let A=j.photo_url,B="true"===b.get("remove_photo"),C=j.photo_url,D=async()=>{if(C)try{let a=C.split("/timeline_photos/")[1];await c.storage.from("timeline_photos").remove([a])}catch(a){console.error("Could not delete old photo:",a)}};if(w){await D();let a=w.name.split(".").pop(),b=`${h.user.id}/${p}-${Date.now()}.${a}`,{error:d}=await c.storage.from("timeline_photos").upload(b,w,{upsert:!0,cacheControl:"3600"});if(d)return{message:"Database Error: Could not upload new photo."};let{data:{publicUrl:e}}=c.storage.from("timeline_photos").getPublicUrl(b);A=e}else B&&(await D(),A=null);let E=null;"theatre"===u?E="Theatre":"ott"===u&&v&&(E=v);let F={watched_on:r,rating:0===s?null:s,notes:t||null,photo_url:A,viewing_context:E},{error:G}=await c.from("timeline_entries").update(F).eq("id",i);if(G)return{message:"Database Error: Could not update your entry."};let{error:H}=await c.from("timeline_collaborators").delete().eq("entry_id",i);if(H&&console.error("Collaborator delete error:",H),x&&x.length>0){let a=x.map(a=>({entry_id:i,user_id:a})),{error:b}=await c.from("timeline_collaborators").insert(a);b&&console.error("Collaborator insert error:",b)}return(0,e.revalidatePath)(`/profile/${h.profile.username}/timeline`),(0,f.redirect)(`/profile/${h.profile.username}/timeline`),{message:"Success"}}async function o(a){let b=await (0,d.createClient)(),c=await (0,g.getUserProfile)();if(!c?.user||!c.profile)return{message:"Authentication Error: You must be logged in to delete an entry.",success:!1};let{data:f,error:h}=await b.from("timeline_entries").select("user_id, photo_url").eq("id",a).single();if(h||!f)return{message:"Error: Could not find the entry.",success:!1};if(f.user_id!==c.user.id)return{message:"Authorization Error: You can only delete your own entries.",success:!1};if(f.photo_url)try{let a=f.photo_url.split("/timeline_photos/")[1];await b.storage.from("timeline_photos").remove([a])}catch(a){console.error("Could not delete photo during entry deletion:",a)}let{error:i}=await b.from("timeline_entries").delete().eq("id",a);return i?{message:"Database Error: Could not delete the entry.",success:!1}:((0,e.revalidatePath)(`/profile/${c.profile.username}/timeline`),{message:"Entry deleted successfully!",success:!0})}async function p(a){let b=await (0,g.getProfileByUsername)(a);return b?await (0,i.getTimelineEntriesByUserId)(b.id):[]}(0,j.ensureServerEntryExports)([m,n,o,p]),(0,b.registerServerReference)(m,"60a1a169e7bb3ce877cd11efc8220db243db8645da",null),(0,b.registerServerReference)(n,"609452658d227815e44ce4b167c179259473801b77",null),(0,b.registerServerReference)(o,"406e281089d76262c7c4bcb5eca369facde7378d41",null),(0,b.registerServerReference)(p,"409a82af5fc534447ddbe25b64a0f0ef2f5bb79870",null),a.s(["deleteTimelineEntry",()=>o,"logEntry",()=>m,"updateTimelineEntry",()=>n])},27918,a=>{"use strict";var b=a.i(76181),c=a.i(58139),d=a.i(68084),e=a.i(90093),f=a.i(38324),g=a.i(71562),h=a.i(18644);a.s([],66632),a.i(66632),a.s(["00683e089f24bf051dde09a3a6d87c7845379672d7",()=>b.getProfileForEdit,"007f4304d26a5fb9f73eb78d5882ca3b3d3f30d5f2",()=>f.createAdminClient,"00a5e44efe8453720c80c4486c1d17d72add854a24",()=>c.logout,"00d0567cd8df0fc447dd1e815c2ddf184f0c18128e",()=>b.getUserProfile,"400bcb2c36f7c47e3731ae06dffd2224b3a2699e1e",()=>b.getFollowRequests,"4014fbfdff9342dd0c42b9ff583a3342422dc0f22a",()=>b.getProfileByUsername,"40153f24d01cf51e6e896446d274d46439a44fa7a1",()=>e.getTimelineEntryById,"401f2c77db66442cf38ce5a83c458e601f1c7b05c7",()=>b.getProfileAndFollowStatus,"402c60c195c27d7e4ee6875efa618185b1ac3231fb",()=>b.getFollowers,"4047dd0ce88f4279733a1b257efef3eef9f46b98fe",()=>b.checkProfileCompletion,"405a83a00c08994b5b17f545dc1643993ea0e7347c",()=>e.getTimelineEntriesByUserId,"40bf4c0ef6c82b5f8fcdc9b4949d7d08040b4dd7de",()=>b.getFollowing,"40cfbf6bd851b4c3c77831a2af2103b1bc31d65c9f",()=>b.getProfileData,"40cfe719a5adbe13aa2b30a3a28352a6402447f1e9",()=>b.getPodiumData,"40d99d04cbee478751a6ae749c1853a5bc0183a343",()=>d.unfollowUser,"40db3109247e2eda43546539812bc50eb62478030b",()=>h.searchProfiles,"60264de08d08b576a3585ab046b1acac7b5bdabd3b",()=>d.followUser,"609452658d227815e44ce4b167c179259473801b77",()=>g.updateTimelineEntry,"60c2b24991e2dd0ce0aa7dddb015e6a9b621b2c5e6",()=>b.checkFollowStatus,"70e9e03f0bdc6e37bedcf6c3e98007fde46de58de2",()=>e.getCinematicEngagement],27918)},56941,a=>{a.v(a=>Promise.resolve().then(()=>a(29024)))}];

//# sourceMappingURL=_9e3befde._.js.map